<div class="form-rdv-container" [formGroup]="form">
  <mat-stepper orientation="vertical" [selectedIndex]="selectedStep">
    <mat-step [stepControl]="quiForm" formGroupName="qui" [formGroup]="quiForm">
      <!-- Label -->
      <ng-template matStepLabel>
        <span *ngIf="!selectedPatient && !quiForm.get('soignant').value">Qui ?</span>
        <span *ngIf="selectedPatient">Patient : {{quiForm.get('patientName').value}}</span>
        <span *ngIf="selectedPatient && quiForm.get('soignant').value"> | </span>
        <span *ngIf="quiForm.get('soignant').value">
        Soignant : {{quiForm.get('soignant').value.prenom}} {{quiForm.get('soignant').value.nom}}
      </span>
      </ng-template>

      <div class="row">
        <!-- Choix du patient -->
        <div class="col-12 col-md-7 row" [ngClass]="{'mandatory': !patient}">
          <p-autoComplete placeholder="Patient" appendTo="body" inputStyleClass="text-capitalize"
                          class="d-inline-block"
                          (keydown.backspace)="clearPatient()"
                          [suggestions]="foundPatients"
                          formControlName="patientName"
                          (onSelect)="selectPatient($event)"
                          (onKeyUp)="clearSearchPatient()"
                          (onFocus)="loadPatients()"
                          (completeMethod)="searchPatient($event)">
            <ng-template let-patient pTemplate="item">
              <span>{{patient.prenom}} {{patient.nom | uppercase}}</span>
              <span *ngIf="patient.dateNaissance" class="small"> (né le {{patient.dateNaissance | date : 'dd/MM/yyyy'}})</span>
            </ng-template>
          </p-autoComplete>
          <!-- Bouton d'ajout -->
          <button *ngIf="proposerNouveau" pButton pRipple pTooltip="Patient non trouvé. L'ajouter ?" (click)="newPatient()"
                  type="button" icon="pi pi-plus" class="ml-1 p-button-rounded p-button-danger p-button-outlined"></button>
        </div>
        <!-- Choix du soignant -->
        <div class="col-12 col-md-5">
          <p-dropdown [options]="soignants" #dropdownSoignant
                      dataKey="id"
                      (onShow)="loadSoignants()"
                      placeholder="Soignant"
                      (keydown.escape)="clearDropdownOnEscape($event, dropdownSoignant)"
                      formControlName="soignant"
                      (onChange)="selectSoigant($event)"
                      appendTo="body"
                      [showClear]="true">
            <!-- Infirmière sélectionée -->
            <ng-template let-value pTemplate="selectedItem">
              {{value.prenom}} {{value.nom}} ({{value.trg}})
            </ng-template>
            <!-- Suggestions autocomplete -->
            <ng-template let-soignant pTemplate="item">
              {{soignant.prenom}} {{soignant.nom}} ({{soignant.trg}})
            </ng-template>
          </p-dropdown>
        </div>
      </div>
    </mat-step>
    <mat-step [stepControl]="quandForm" formGroupName="quand" [formGroup]="quandForm">
      <ng-template matStepLabel>Quand ?</ng-template>

      <ng-template matStepContent>
        <div class="row justify-content-center quand-form">
          <!-- Date -->
          <div class="col-12 row justify-content-center">
            <h5 class="col-12">Sélectionner la date</h5>
            <p-calendar formControlName="date"
                        class="d-block"
                        [monthNavigator]="true"
                        [yearNavigator]="true"
                        [yearRange]="'2021:' + (minDate.getFullYear() + 5)"
                        [minDate]="minDate"
                        (onMonthChange)="selectMonth($event)"
                        (onYearChange)="selectMonth($event)"
                        (onSelect)="selectDay($event, rdvHour)"
                        [inline]="true"></p-calendar>
          </div>

          <!-- Créneaux -->
          <div #rdvHour class="col-12 row justify-content-center mt-2 pb-4">
            <h5 class="col-12">{{date ? 'Sélectionner l\'heure du rdv' : ''}}</h5>
            <div class="row justify-content-center mt-1 mb-2 col-6 col-md-4 col-lg-3" *ngFor="let horaire of horaires">
              <app-select-button *ngIf="date"
                                 [statut]="horaire.statut"
                                 [selected]="heure === horaire.heure"
                                 [value]="horaire.heureString"
                                 (onSelectedHour)="selectHour(horaire.heure)"></app-select-button>
            </div>
          </div>
        </div>
      </ng-template>
    </mat-step>
    <mat-step [stepControl]="quandForm" formGroupName="quand" [formGroup]="quandForm">
      <ng-template matStepLabel>Statut : {{quandForm.get('status').value.label}}</ng-template>
      <div class="row col-12 justify-content-center">
        <p-dropdown [options]="rdvStatus.all()" formControlName="status" appendTo="body">
        </p-dropdown>
      </div>
    </mat-step>
  </mat-stepper>

  <div class="footer">
    <p-button icon="pi pi-times" (click)="ref.close()" label="Annuler" styleClass="p-button-text"></p-button>
    <button type="submit" pButton icon="pi pi-check" (click)="save()" class="p-button-text" [disabled]="form.untouched || form.invalid" [label]="rdv ? 'Enregistrer':'Créer'"></button>
  </div>
</div>
